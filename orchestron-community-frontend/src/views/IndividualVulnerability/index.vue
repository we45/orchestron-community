<template>
    <div>
        <b-row>
            <b-col cols="4"></b-col>
            <b-col cols="6">
                <button-groups
                  :markTruePositive="markTruePositive"
                  :fixVulnerability="fixVulnerability"
                  :updateVul="updateVul"
                  :raiseBug="raiseBug"
                  @markFalsePositiveModal="markFalsePositiveModal"
                  @fixVulerabilityModal="fixVulerabilityModal"
                  :markFalsePositive="markFalsePositive"
                  @markTruePositiveModal="markTruePositiveModal" @raiseBugTicketModal="raiseBugTicketModal"></button-groups>
            </b-col>
            <b-col cols="2"></b-col>
        </b-row>
        <br/>
        <b-container fluid>
            <b-card>
                <b-row>
                    <b-col cols="8">
                        <p class="vul-name">{{ actualVulName }}  <b-badge
                            variant="danger" style="font-size: 0.8em;" v-if="markTruePositive">False Positive</b-badge></p>
                    </b-col>
                    <b-col cols="3">
                    </b-col>
                    <b-col cols="1">
                        <span size="sm" class="high" v-if="sev===3">High</span>
                        <span size="sm" class="medium" v-if="sev===2">Medium</span>
                        <span size="sm" class="low" v-if="sev===1">Low</span>
                        <span size="sm" class="info" v-if="sev===0">Info</span>
                    </b-col>
                </b-row>
                <b-tabs pills card >
                    <b-tab title="Basic Info" active v-if="basicInfo.length>0">
                        <basic-info :basicInfoData="basicInfo"></basic-info>
                    </b-tab>
                    <b-tab title="Vulnerability Info" v-if="description">
                        <vulnerability-info :vulInfo="vulInfo"  :description="description"></vulnerability-info>
                    </b-tab>
                    <b-tab title="Affected Instances" v-if="affectedInstances.length > 0">
                        <affected-instances :affectedInstances="affectedInstances"></affected-instances>
                    </b-tab>
                </b-tabs>
            </b-card>
            <!--Fix Vulnerability-->
            <b-modal
                ref="fixVulModal"
                title="Fix this vulnerability"
                size="lg"
                centered>
                <div>
                    <form @submit.prevent="submitFixVul">
                        <b-row class="my-1">
                            <b-col sm="2"><label class="label">Description:</label></b-col>
                            <b-col sm="10">
                                <b-form-textarea
                                    v-model="fixVulDesc"
                                    type="text"
                                    class="inline-form-control"
                                    :rows="3"
                                    :max-rows="6"
                                    placeholder="Enter Description" :state="!$v.fixVulDesc.$invalid"></b-form-textarea>
                            </b-col>
                        </b-row>
                        <br>
                        <b-row class="my-1">
                            <b-col sm="2"><label class="label">File:</label></b-col>
                            <b-col sm="10">
                                <b-form-file
                                    v-model="fixVulEvid"
                                    placeholder="Choose a logo..."
                                    accept="image/jpeg, image/png,image/jpg,"></b-form-file>
                                <br>
                                <p>{{ fixVulEvid.name }}</p>
                            </b-col>
                        </b-row>
                        <br>
                    </form>
                </div>
                <b-col col="12" slot="modal-footer">
                    <div class="pull-right" style="float: right">
                        <button type="button" class="btn btn-orange-close pull-right" @click=" closeFixVul() "> Close</button>
                        <button type="button" class="btn btn-orange-submit pull-right" data-dismiss="modal" @click=" submitFixVul() " v-if="!$v.fixVulDesc.$invalid">
                        Submit
                        </button>
                    </div>
                </b-col>
            </b-modal>

            <!--MarkFalsePositive-->
          <b-modal
                ref="markFalsePositive"
                title="Mark False Positive"
                size="lg"
                centered>
                <div>
                    <form @submit.prevent="submitMarkFalsePositive">
                        <h5>Are you sure you want to continue?</h5>
                    </form>
                </div>
                <b-col col="12" slot="modal-footer">
                    <div class="pull-right" style="float: right">
                      <button type="button" class="btn btn-orange-submit pull-right" data-dismiss="modal" @click=" submitMarkFalsePositive()">
                        Yes
                        </button>
                        <button type="button" class="btn btn-orange-close pull-right" @click=" closeMarkFalsePositive() "> No</button>
                    </div>
                </b-col>
            </b-modal>

          <!--ModalTruePositive-->
          <b-modal
                ref="markTruePositive"
                title="Mark True Positive"
                size="lg"
                centered>
                <div>
                    <form @submit.prevent="submitMarkTruePositive">
                        <h5>Are you sure you want to continue?</h5>
                    </form>
                </div>
                <b-col col="12" slot="modal-footer">
                    <div class="pull-right" style="float: right">
                      <button type="button" class="btn btn-orange-submit pull-right" data-dismiss="modal" @click=" submitMarkTruePositive()">
                        Yes
                        </button>
                        <button type="button" class="btn btn-orange-close pull-right" @click=" closeMarkTruePositive() "> No</button>
                    </div>
                </b-col>
            </b-modal>

           <!--Raise Bugs-->
            <b-modal ref="raiseBugModal" title="Raise Bug" size="lg" centered>
                <div>
                    <form @submit.prevent="submitRaiseBugVul">
                        <b-row class="my-1">
                            <b-col sm="2"><label class="label">Issue Type:</label></b-col>
                            <b-col sm="10">
                                <v-select v-model="bugIssueType" :options="bugIssueTypeOption" placeholder="Select Issue Type"></v-select>
                            </b-col>
                        </b-row>
                        <br>
                        <b-row class="my-1">
                            <b-col sm="2"><label class="label">Assignee:</label></b-col>
                            <b-col sm="10">
                                <v-select v-model="bugAssignee" :options="bugAssigneeOption" placeholder="Select Assignee"></v-select>
                            </b-col>
                        </b-row>
                        <br>
                    </form>
                </div>
                <b-col col="12" slot="modal-footer">
                    <div class="pull-right" style="float: right">
                        <button type="button" class="btn btn-orange-close pull-right" @click=" closeRaiseBugVul() "> Close</button>
                        <button type="button" class="btn btn-orange-submit pull-right" data-dismiss="modal" @click=" submitRaiseBugVul() " v-if="!$v.bugIssueType.$invalid && !$v.bugAssignee.$invalid">
                        Submit
                        </button>
                    </div>
                </b-col>
            </b-modal>
        </b-container>
    </div>
</template>

<script>
  import BasicInfo from '@/components/IndividualVulnerability/BasicInfo'
  import VulnerabilityInfo from '@/components/IndividualVulnerability/VulnerabilityInfo'
  import AffectedInstances from '@/components/IndividualVulnerability/AffectedInstances'
  import ButtonGroups from '@/components/IndividualVulnerability/ButtonGroups'
  import axios from '@/utils/auth'
  import { notValidUser } from '@/utils/checkAuthUser'
  import { required, minLength } from 'vuelidate/lib/validators'

  export default {
    name: 'IndividualVulnerability',
    data() {
      return {
        vulName: '',
        actualVulName: '',
        sev: '',
        basicInfo: [],
        markTruePositive: false,
        fixVulnerability: true,
        updateVul: false,
        raiseBug: false,
        markFalsePositive: true,
        vulInfo: [],
        affectedInstances: [],
        examples: [],
        vulDesc: '',
        fixVulDesc: '',
        fixVulEvid: '',
        appId: '',
        description: false,
        bugIssueType: '',
        bugAssignee: '',
        bugAssigneeOption: '',
        bugIssueTypeOption: ''
      }
    },
    validations: {
      fixVulDesc: {
        required,
        minLength: minLength(1)
      },
      bugIssueType: {
        required
      },
      bugAssignee: {
        required
      }
    },
    components: {
      ButtonGroups,
      BasicInfo,
      VulnerabilityInfo,
      AffectedInstances
    },
    created() {
      this.org = localStorage.getItem('org')
      this.token = localStorage.getItem('token')
      this.appName = this.$route.params.appName
      this.vulName = this.$route.params.vulName
      this.cwe = this.$route.params.cwe
      this.fetchData()
    },
    methods: {
      fetchData() {
        if (this.org && this.token) {
          axios.get('/openvul/' + this.appName + '/' + this.vulName + '/' + this.cwe)
            .then(res => {
              for (const val of Object.values(res.data)) {
                this.appId = val.app_id
                this.markTruePositive = val.is_false_positive
                if (val.is_false_positive) {
                  this.markFalsePositive = false
                }
                this.actualVulName = val.names[0][0]
                this.sev = val.sev
                this.vulDesc = val.description
                this.vulInfo.push({
                  desc: val.description
                })
                if (val.bug_id != null) {
                  this.raiseBug = true
                }
                this.basicInfo.push({
                  'appName': val.names[0][1],
                  'appUrl': val.app_url,
                  'tool': val.tools,
                  'owasp': val.owasp,
                  'cwe': val.cwe,
                  'openFor': val.open_for,
                  'languages': val.languages,
                  'bugStatus': val.bug_status,
                  'bugId': val.bug_id,
                  'dread': val.dread,
                  'dreadValues': 'Damage: ' + val.damage + '\n' + 'Reproducibility: ' + val.reproducibility +
                  '\n' + 'Exploitability: ' + val.exploitability + '\n' + 'Affected Users: ' + val.affected_users +
                  '\n' + 'Discoverability: ' + val.discoverability
                })
                for (const [key, param] of Object.entries(val.evidences)) {
                  const url = btoa(unescape(encodeURIComponent(event.key)))
                  this.affectedInstances.push({
                    evidence: key,
                    details: param.params,
                    reqResp: param.req_res_present,
                    url: '/org/individual_vul_req_resp/' + this.appName + '/' + this.vulName + '/' + this.cwe + '/' + url + '/'
                  })
                }
              }

              axios.get('/applications/' + this.appId + '/jira')
                .then(res => {
                  this.raiseBug = true
                }).catch(error => {
                  if (error.res.status === 404) {
                    this.$router.push('/not_found')
                  } else if (error.res.status === 403) {
                    this.$router.push('/forbidden')
                  } else {
                    this.$router.push('/error')
                  }
                })
            }).catch(error => {
              if (error.res.status === 404) {
                this.$router.push('/not_found')
              } else if (error.res.status === 403) {
                this.$router.push('/forbidden')
              } else {
                this.$router.push('/error')
              }
            })
        } else {
          notValidUser()
          this.$router.push('/')
        }
      },
      markFalsePositiveModal() {
        this.$refs.markFalsePositive.show()
      },
      closeMarkFalsePositive() {
        this.$refs.markFalsePositive.hide()
      },
      submitMarkFalsePositive() {
        if (this.org && this.token) {
          const form_data = {
            'name': this.actualVulName,
            'cwe': atob(this.cwe)
          }
          axios.post('/openvul/app/mark/false/' + this.appId + '/', form_data)
            .then(res => {
              this.$refs.fixVulModal.hide()
              this.$router.push('/org/openvuls/')
              this.$notify({
                group: 'foo',
                type: 'success',
                title: 'Vulnerability',
                text: 'The vulnerability has been fixed Successfully!',
                position: 'top right'
              })
            }).catch(error => {
              if (error.res.status === 404) {
                this.$router.push('/not_found')
              } else if (error.res.status === 403) {
                this.$router.push('/forbidden')
              } else {
                this.$router.push('/error')
              }
            })
        } else {
          notValidUser()
          this.$router.push('/')
        }
      },
      markTruePositiveModal() {
        this.$refs.markTruePositive.show()
      },
      closeMarkTruePositive() {
        this.$refs.markTruePositive.hide()
      },
      submitMarkTruePositive() {
        if (this.org && this.token) {
          const form_data = {
            'name': this.actualVulName,
            'cwe': atob(this.cwe)
          }
          axios.post('/openvul/app/mark/true/' + this.appId + '/', form_data)
            .then(res => {
              this.$refs.fixVulModal.hide()
              this.$router.push('/org/openvuls/')
              this.$notify({
                group: 'foo',
                type: 'success',
                title: 'Vulnerability',
                text: 'The vulnerability has been fixed Successfully!',
                position: 'top right'
              })
            }).catch(error => {
              if (error.res.status === 404) {
                this.$router.push('/not_found')
              } else if (error.res.status === 403) {
                this.$router.push('/forbidden')
              } else {
                this.$router.push('/error')
              }
            })
        } else {
          notValidUser()
          this.$router.push('/')
        }
      },
      fixVulerabilityModal() {
        this.$refs.fixVulModal.show()
      },
      closeFixVul() {
        this.$refs.fixVulModal.hide()
      },
      submitFixVul() {
        if (this.org && this.token) {
          const form_data = new FormData()
          form_data.append('vul', this.actualVulName)
          form_data.append('file', this.fixVulEvid)
          form_data.append('description', this.fixVulDesc)
          axios.post('/openvul/remediate/' + this.appName + '/' + this.vulName + '/' + this.cwe + '/', form_data, {
            headers: {
              'Content-Type': 'multipart/form-data'
            }
          })
            .then(res => {
              this.$refs.fixVulModal.hide()
              this.$router.push('/org/openvuls')
              this.$notify({
                group: 'foo',
                type: 'success',
                title: 'Vulnerability',
                text: 'The vulnerability has been fixed Successfully!',
                position: 'top right'
              })
            }).catch(error => {
              if (error.res.status === 404) {
                this.$router.push('/not_found')
              } else if (error.res.status === 403) {
                this.$router.push('/forbidden')
              } else {
                this.$router.push('/error')
              }
            })
        } else {
          notValidUser()
          this.$router.push('/')
        }
      },
      raiseBugTicketModal() {
        if (this.org && this.token) {
          this.$refs.raiseBugModal.show()
          axios.get('/jira/users/' + this.appId)
            .then(res => {
              this.bugAssigneeOption = res.data
            }).catch(error => {
              if (error.res.status === 404) {
                this.$router.push('/not_found')
              } else if (error.res.status === 403) {
                this.$router.push('/forbidden')
              } else {
                this.$router.push('/error')
              }
            })

          axios.get('/jira/issuetypes/' + this.appId)
            .then(res => {
              this.bugIssueTypeOption = res.data
            }).catch(error => {
              if (error.res.status === 404) {
                this.$router.push('/not_found')
              } else if (error.res.status === 403) {
                this.$router.push('/forbidden')
              } else {
                this.$router.push('/error')
              }
            })
        } else {
          notValidUser()
          this.$router.push('/')
        }
      },
      closeRaiseBugVul() {
        this.$refs.raiseBugModal.hide()
      },
      submitRaiseBugVul() {
        if (this.org && this.token) {
          const form_data = {
            'name': this.actualVulName,
            'cwe': atob(this.cwe),
            'issuetype': this.bugIssueType,
            'assignee': this.bugAssignee
          }
          axios.post('/openvul/app/raise/jira/' + this.appId + '/', form_data)
            .then(res => {
              this.$refs.raiseBugModal.hide()
              this.$router.push('/org/openvuls')
              this.$notify({
                group: 'foo',
                type: 'success',
                title: 'Vulnerability',
                text: 'The JIRA tikect has been raised Successfully!',
                position: 'top right'
              })
            }).catch(error => {
              if (error.res.status === 404) {
                this.$router.push('/not_found')
              } else if (error.res.status === 403) {
                this.$router.push('/forbidden')
              } else {
                this.$router.push('/error')
              }
            })
        } else {
          notValidUser()
          this.$router.push('/')
        }
      }
    }
  }

</script>

<style scoped>
  .vul-name {
      font-family: 'Avenir';
      font-size: 14px;
      font-weight: 600;
      line-height: 0.99;
      text-align: left;
      color: #232328;
  }
    .high {
      display: inline-block;
      min-width: 35px;
      padding: 3px 7px;
      font-size: 12px;
      font-weight: 600;
      line-height: 1.75;
      color: #FFFFFF;
      text-align: center;
      font-family: 'Avenir';
      white-space: nowrap;
      vertical-align: middle;
      background-color: #d11d55;
      height: 25px;
      margin-right: 3%;
  }
  .medium {
      display: inline-block;
      min-width: 35px;
      padding: 3px 7px;
      font-size: 12px;
      font-weight: 600;
      line-height: 1.75;
      color: #FFFFFF;
      text-align: center;
      font-family: 'Avenir';
      white-space: nowrap;
      vertical-align: middle;
      background-color: #ff9c2c;
      height: 25px;
      margin-right: 3%;
  }
  .low {
      display: inline-block;
      min-width: 35px;
      padding: 3px 7px;
      font-size: 12px;
      font-weight: 600;
      line-height: 1.75;
      color: #FFFFFF;
      text-align: center;
      font-family: 'Avenir';
      white-space: nowrap;
      vertical-align: middle;
      background-color: #008b8f;
      height: 25px;
      margin-right: 3%;
  }
  .info {
      display: inline-block;
      min-width: 35px;
      padding: 3px 7px;
      font-size: 12px;
      font-weight: 600;
      line-height: 1.75;
      color: #FFFFFF;
      text-align: center;
      font-family: 'Avenir';
      white-space: nowrap;
      vertical-align: middle;
      background-color: #1d1e52;
      height: 25px;
      margin-right: 3%;
  }

  .btn-orange-close {
    color: #ff542c;
    background-color: #FFFFFF;
    border-color: #ff542c;
    font-family: 'Avenir';
    border-radius: 14px;
    padding: 3px 12px;
    margin-bottom: 0;
    font-size: 14px;
    /*height: 20px;*/

  }

  .btn-orange-close:focus,
  .btn-orange-close.focus {
    color: #ff542c;
    background-color: #FFFFFF;
    border-color: #ff542c;
    font-family: 'Avenir';
    border-radius: 14px;
    padding: 3px 12px;
    margin-bottom: 0;
    font-size: 14px;
  }

  .btn-orange-close:hover {
    color: #FFFFFF;
    background-color: #ff542c;
    border-color: #FFFFFF;
    font-family: 'Avenir';
    border-radius: 14px;
    padding: 3px 12px;
    margin-bottom: 0;
    font-size: 14px;
  }
  .btn-orange-submit {
    color: #FFFFFF;
    background-color: #ff542c;
    border-color: #FFFFFF;
    font-family: 'Avenir';
    border-radius: 14px;
    padding: 3px 12px;
    margin-bottom: 0;
    font-size: 14px;
    /*height: 40px;*/

  }

  .btn-orange-submit:focus,
  .btn-orange-submit.focus {
    color: #FFFFFF;
    background-color: #ff542c;
    border-color: #FFFFFF;
    font-family: 'Avenir';
    border-radius: 14px;
    padding: 3px 12px;
    margin-bottom: 0;
    font-size: 14px;
  }

  .btn-orange-submit:hover {
    color: #FFFFFF;
    background-color: #ff542c;
    border-color: #FFFFFF;
    font-family: 'Avenir';
    border-radius: 14px;
    padding: 3px 12px;
    margin-bottom: 0;
    font-size: 14px;
  }

  .label{
    font-family: 'Avenir';
    font-size: 16px;
    line-height: 1.33;
    color: #000000;
  }

  .inline-form-control {
    box-sizing: border-box;
    -webkit-box-sizing: border-box;
    -moz-box-sizing: border-box;
    outline: none;
    width: 100%;
    padding: 7px;
    border: none;
    border-bottom: 1px solid #ddd;
    background: transparent;
    margin-bottom: 10px;
    font: 16px 'Avenir';
    height: 45px;
    position: relative;
    display: inline-block;
  }
</style>
